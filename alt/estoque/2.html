<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estoque (frontend simples)</title>
</head>
<body>

  <h2>üì¶ Estoque (frontend)</h2>

  <div>
    <label>Busca por descri√ß√£o:</label><br />
    <input id="busca" type="text" placeholder="Digite para buscar..." />
  </div>

  <hr />

  <div>
    <label>Operador entre filtros:</label><br />
    <label><input type="radio" name="op" value="AND" checked> AND</label>
    <label><input type="radio" name="op" value="OR"> OR</label>
  </div>

  <hr />

  <h3>Filtros</h3>

  <div id="filtros"></div>

  <button id="addFiltro">+ Adicionar filtro</button>
  <button id="limpar">Limpar filtros</button>

  <hr />

  <div id="info"></div>

  <div id="status"></div>

  <table border="1" cellpadding="6" cellspacing="0">
    <thead>
      <tr>
        <th>Imagem</th>
        <th>C√≥d</th>
        <th>Descri√ß√£o</th>
        <th>Categoria</th>
        <th>Qtde</th>
        <th>Pre√ßo</th>
        <th>Ativo</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, getDocsFromCache, persistentLocalCache, initializeFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyBjvTgvMxOiUcJzud6Vapa5X8ZnGeph0aA",
      authDomain: "papelaria-79dc5.firebaseapp.com",
      projectId: "papelaria-79dc5",
      storageBucket: "papelaria-79dc5.firebasestorage.app",
      messagingSenderId: "730323947354",
      appId: "1:730323947354:web:6a61e2312a6cc4e361ad63"
    };
  
    const app = initializeApp(firebaseConfig);

    const db = initializeFirestore(app, {
      localCache: persistentLocalCache()
    });

    let produtos = [];
    
    function setStatusCarregando() {
      const el = document.getElementById("status");
      el.style.color = "#555";
      el.innerText = "‚è≥ Carregando produtos...";
    }
    
    function setStatusErro(msg) {
      const el = document.getElementById("status");
      el.style.color = "#b00020";
      el.innerText = "‚ùå Erro ao carregar produtos: " + msg;
    }
    
    function setStatusOk(qtde) {
      const el = document.getElementById("status");
      el.style.color = "#0a7";
      el.innerText = `‚úÖ ${qtde} produto(s) carregado(s)`;
    }

    async function carregarProdutosFirestore() {
      try {
        setStatusCarregando();

        const colRef = collection(db, "produtos");
        let snap;

        try {
          snap = await getDocsFromCache(colRef);

          if (snap.empty) {
            throw new Error("Cache vazio");
          }

          console.log("üíæ Produtos carregados do CACHE");

        } catch {
          console.log("üåê Cache vazio, buscando da REDE...");
          snap = await getDocs(colRef);
        }

        produtos = snap.docs.map(d => {
          const p = d.data();
          return {
            cod: p.cod ?? "",
            descricao: p.descricao ?? "",
            categoria: p.categoria ?? "",
            qtde: Number(p.qtde ?? 0),
            precoVenda: Number(p.precoVenda ?? 0),
            ativo: Boolean(p.ativo),
            imagem: p.imagem ?? ""
          };
        });

        setStatusOk(produtos.length);
        atualizar();

      } catch (err) {
        console.error(err);
        setStatusErro(err.message || "Erro desconhecido");
      }
    }
    
    // ====== estado ======
    let termoBusca = "";
    let operadorGlobal = "AND"; // AND | OR

    // ====== helpers ======
    function normalizar(str) {
      return String(str ?? "")
        .toLowerCase()
        .trim()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function parseValor(campo, valorStr) {
      const v = String(valorStr ?? "").trim();

      if (campo === "qtde" || campo === "precoVenda") return Number(v);
      if (campo === "ativo") {
        const n = normalizar(v);
        return (n === "sim" || n === "true" || n === "1");
      }
      return v;
    }

    function aplicaCondicao(prod, campo, operador, valor) {
      const valProd = prod[campo];

      if (campo === "descricao" || campo === "categoria") {
        const a = normalizar(valProd);
        const b = normalizar(valor);

        if (operador === "contains") return a.includes(b);
        if (operador === "==") return a === b;
        return false;
      }

      if (campo === "qtde" || campo === "precoVenda") {
        const a = Number(valProd);
        const b = Number(valor);
        if (Number.isNaN(b)) return false;

        if (operador === "==") return a === b;
        if (operador === ">")  return a > b;
        if (operador === "<")  return a < b;
        return false;
      }

      if (campo === "ativo") {
        const a = Boolean(valProd);
        const b = Boolean(valor);
        if (operador === "==") return a === b;
        return false;
      }

      return false;
    }

    function obterFiltrosDaTela() {
      const rows = [...document.querySelectorAll(".filtro-row")];

      const filtros = rows.map(r => {
        const campo = r.querySelector(".campo").value;
        const operador = r.querySelector(".operador").value;
        const valorRaw = r.querySelector(".valor").value;

        return { campo, operador, valor: parseValor(campo, valorRaw), valorRaw };
      });

      // remove vazios
      return filtros.filter(f => {
        if (!String(f.valorRaw).trim()) return false;
        if ((f.campo === "qtde" || f.campo === "precoVenda") && !Number.isFinite(f.valor)) return false;
        return true;
      });
    }

    function filtrar() {
      const t = normalizar(termoBusca);
      const filtros = obterFiltrosDaTela();

      return produtos.filter(p => {
        // busca simples por descri√ß√£o
        const passaTexto = !t || normalizar(p.descricao).includes(t);

        if (!filtros.length) return passaTexto;

        const resultados = filtros.map(f =>
          aplicaCondicao(p, f.campo, f.operador, f.valor)
        );

        const passaFiltros =
          operadorGlobal === "AND"
            ? resultados.every(Boolean)
            : resultados.some(Boolean);

        return passaTexto && passaFiltros;
      });
    }

    function renderTabela(lista) {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      for (const p of lista) {
        const tr = document.createElement("tr");

        const imagemHTML = p.imagem
          ? `<img 
                src="${p.imagem}" 
                loading="lazy"
                style="width:50px;height:50px;object-fit:cover;border-radius:6px;"
                alt="Imagem do produto"
            >`
          : `<span style="color:#999;font-size:12px;">Sem imagem</span>`;

        tr.innerHTML = `
          <td>${imagemHTML}</td>
          <td>${p.cod}</td>
          <td>${p.descricao}</td>
          <td>${p.categoria}</td>
          <td>${p.qtde}</td>
          <td>R$ ${Number(p.precoVenda).toFixed(2)}</td>
          <td>${p.ativo ? "Sim" : "N√£o"}</td>
        `;

        tbody.appendChild(tr);
      }

      document.getElementById("info").innerText =
        `Mostrando ${lista.length} produto(s).`;
    }

    function atualizar() {
      renderTabela(filtrar());
    }

    // ====== UI de filtro ======
    function criarRowFiltro() {
      const div = document.createElement("div");
      div.className = "filtro-row";
      div.innerHTML = `
        <select class="campo">
          <option value="categoria">Categoria</option>
          <option value="qtde">Estoque</option>
          <option value="precoVenda">Pre√ßo</option>
          <option value="ativo">Ativo</option>
          <option value="descricao">Descri√ß√£o</option>
        </select>

        <select class="operador"></select>

        <input class="valor" placeholder="Valor" />

        <button type="button" class="remover">X</button>
      `;

      const selCampo = div.querySelector(".campo");
      const selOp = div.querySelector(".operador");

      function popularOperadores() {
        const c = selCampo.value;
        selOp.innerHTML = "";

        if (c === "categoria" || c === "descricao") {
          selOp.innerHTML = `
            <option value="contains">cont√©m</option>
            <option value="==">igual</option>
          `;
        } else if (c === "ativo") {
          selOp.innerHTML = `<option value="==">igual</option>`;
          div.querySelector(".valor").placeholder = 'Digite: "sim" ou "nao"';
        } else {
          selOp.innerHTML = `
            <option value="==">=</option>
            <option value=">">></option>
            <option value="<"><</option>
          `;
          div.querySelector(".valor").placeholder = "N√∫mero";
        }
      }

      popularOperadores();
      selCampo.addEventListener("change", () => {
        popularOperadores();
        atualizar();
      });

      div.querySelector(".operador").addEventListener("change", atualizar);
      div.querySelector(".valor").addEventListener("input", atualizar);

      div.querySelector(".remover").onclick = () => {
        div.remove();
        atualizar();
      };

      return div;
    }

    // ====== eventos ======
    document.getElementById("busca").addEventListener("input", (e) => {
      termoBusca = e.target.value;
      atualizar();
    });

    document.querySelectorAll('input[name="op"]').forEach(r => {
      r.addEventListener("change", () => {
        operadorGlobal = document.querySelector('input[name="op"]:checked').value;
        atualizar();
      });
    });

    document.getElementById("addFiltro").onclick = () => {
      document.getElementById("filtros").appendChild(criarRowFiltro());
      atualizar();
    };

    document.getElementById("limpar").onclick = () => {
      document.getElementById("filtros").innerHTML = "";
      atualizar();
    };

    // ====== start ======
    document.getElementById("filtros").appendChild(criarRowFiltro());
    carregarProdutosFirestore();
  </script>
</body>
</html>