<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estoque (frontend)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #f4f4f4; }
    .topbar { position: sticky; top: 0; background: white; padding: 12px 14px; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .title { font-weight: 700; }
    .search { flex: 1; display: flex; gap: 10px; align-items: center; }
    input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
    .btn { border: 0; padding: 10px 12px; border-radius: 10px; cursor: pointer; }
    .btn.primary { background: #386c6f; color: #fff; }
    .btn.ghost { background: #fff; border: 1px solid #ddd; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .wrap { padding: 14px; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { font-size: 12px; color: #555; background: #fafafa; }
    .muted { color: #666; font-size: 13px; }

    /* modal */
    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; padding: 16px; }
    .backdrop.open { display: flex; }
    .modal { width: min(720px, 100%); background: #fff; border-radius: 14px; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,.25); }
    .modal-head, .modal-foot { padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; gap: 10px; background: #fff; }
    .modal-head { border-bottom: 1px solid #eee; }
    .modal-body { padding: 12px 14px; background: #fff; }
    .rows { display: flex; flex-direction: column; gap: 10px; margin: 10px 0; }
    .row { display: grid; grid-template-columns: 1.2fr .8fr 1fr auto; gap: 10px; }
    select, .row input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
    .radio { display: flex; gap: 14px; align-items: center; }
    .chip { display: inline-flex; gap: 8px; align-items: center; padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; font-size: 13px; }
    .danger { color: #b00020; }
    .ok { color: #0a7; }
    .hint { font-size: 12px; color: #777; margin-top: 6px; }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="title">üì¶ Estoque</div>

    <div class="search">
      <input id="busca" type="text" placeholder="Buscar por descri√ß√£o..." autocomplete="off" />
      <button class="btn ghost" id="btnFiltros">Filtros</button>
    </div>

    <span class="chip" id="statusFiltro">Sem filtros</span>
  </div>

  <div class="wrap">
    <div class="muted" id="info"></div>

    <table>
      <thead>
        <tr>
          <th>C√≥d</th>
          <th>Descri√ß√£o</th>
          <th>Categoria</th>
          <th>Estoque</th>
          <th>Pre√ßo</th>
          <th>Ativo</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="modal">
    <div class="modal">
      <div class="modal-head">
        <strong>Filtros avan√ßados</strong>
        <button class="btn ghost" id="btnFechar">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="radio">
          <label class="chip">
            <input type="radio" name="op" value="AND" checked />
            <span>E (todas)</span>
          </label>
          <label class="chip">
            <input type="radio" name="op" value="OR" />
            <span>OU (qualquer)</span>
          </label>
        </div>

        <div class="rows" id="rows"></div>

        <button class="btn ghost" id="btnAdd">+ Adicionar filtro</button>
        <div class="hint">Dica: estoque e pre√ßo aceitam &gt; e &lt;. Categoria aceita "cont√©m". Ativo aceita Sim/N√£o.</div>
      </div>

      <div class="modal-foot">
        <button class="btn ghost" id="btnLimpar">Limpar</button>
        <button class="btn primary" id="btnAplicar">Aplicar</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 1) Base fake (troque pelos seus dados)
    // =========================
    const produtos = [
      { cod: "001", descricao: "Caneta azul", categoria: "Escrita", qtde: 12, precoVenda: 3.5, ativo: true },
      { cod: "002", descricao: "Caneta preta", categoria: "Escrita", qtde: 2,  precoVenda: 3.5, ativo: true },
      { cod: "003", descricao: "Caderno brochura 96 folhas", categoria: "Cadernos", qtde: 20, precoVenda: 18.9, ativo: true },
      { cod: "004", descricao: "L√°pis HB", categoria: "Escrita", qtde: 0, precoVenda: 1.9, ativo: false },
      { cod: "005", descricao: "Borracha branca", categoria: "Escrita", qtde: 5, precoVenda: 2.2, ativo: true },
      { cod: "006", descricao: "Estojo escolar", categoria: "Acess√≥rios", qtde: 8, precoVenda: 29.9, ativo: true },
    ];

    // =========================
    // 2) Estado
    // =========================
    let termoBusca = "";
    let operadorGlobal = "AND";
    let filtrosAtivos = [];

    // =========================
    // 3) Helpers
    // =========================
    function normalizar(str) {
      return String(str ?? "")
        .toLowerCase()
        .trim()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function normalizarValor(campo, valorStr) {
      const v = String(valorStr ?? "").trim();

      if (campo === "qtde" || campo === "precoVenda") return Number(v);
      if (campo === "ativo") {
        const n = normalizar(v);
        return (n === "sim" || n === "true" || n === "1");
      }
      return v;
    }

    function aplicaCondicao(prod, f) {
      const campo = f.campo;
      const op = f.operador;
      const valor = f.valor;

      const valProd = prod[campo];

      if (campo === "descricao" || campo === "categoria") {
        const a = normalizar(valProd);
        const b = normalizar(valor);

        if (op === "contains") return a.includes(b);
        if (op === "==") return a === b;
        return false;
      }

      if (campo === "qtde" || campo === "precoVenda") {
        const a = Number(valProd);
        const b = Number(valor);
        if (Number.isNaN(b)) return false;

        if (op === "==") return a === b;
        if (op === ">")  return a > b;
        if (op === "<")  return a < b;
        return false;
      }

      if (campo === "ativo") {
        const a = Boolean(valProd);
        const b = Boolean(valor);
        if (op === "==") return a === b;
        return false;
      }

      return false;
    }

    function filtrarFrontend() {
      const t = normalizar(termoBusca);

      return produtos.filter(p => {
        // Busca por descri√ß√£o (input principal)
        const passaTexto = !t || normalizar(p.descricao).includes(t);

        // Filtros do modal
        if (!filtrosAtivos.length) return passaTexto;

        const resultados = filtrosAtivos.map(f => aplicaCondicao(p, f));

        const passaFiltros =
          operadorGlobal === "AND"
            ? resultados.every(Boolean)
            : resultados.some(Boolean);

        return passaTexto && passaFiltros;
      });
    }

    // =========================
    // 4) Render
    // =========================
    function renderTabela(lista) {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      for (const p of lista) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.cod}</td>
          <td>${p.descricao}</td>
          <td>${p.categoria}</td>
          <td>${p.qtde}</td>
          <td>R$ ${Number(p.precoVenda).toFixed(2)}</td>
          <td>${p.ativo ? "Sim" : "N√£o"}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById("info").innerText =
        `Mostrando ${lista.length} de ${produtos.length} produto(s).`;
    }

    function atualizarStatusFiltro() {
      const el = document.getElementById("statusFiltro");
      if (!filtrosAtivos.length) {
        el.textContent = "Sem filtros";
        el.classList.remove("ok");
        return;
      }
      el.textContent = `${operadorGlobal} ‚Ä¢ ${filtrosAtivos.length} filtro(s)`;
      el.classList.add("ok");
    }

    function atualizarTudo() {
      atualizarStatusFiltro();
      renderTabela(filtrarFrontend());
    }

    // =========================
    // 5) Modal: cria√ß√£o de rows
    // =========================
    function criarRowFiltro() {
      const div = document.createElement("div");
      div.className = "row";
      div.innerHTML = `
        <select class="campo">
          <option value="categoria">Categoria</option>
          <option value="qtde">Estoque</option>
          <option value="precoVenda">Pre√ßo</option>
          <option value="ativo">Ativo</option>
        </select>

        <select class="operador"></select>

        <input class="valor" placeholder="Valor" />

        <button class="btn ghost remover">‚úï</button>
      `;

      const selCampo = div.querySelector(".campo");
      const selOp = div.querySelector(".operador");

      function popularOperadores() {
        const c = selCampo.value;
        selOp.innerHTML = "";

        if (c === "categoria") {
          selOp.innerHTML = `
            <option value="contains">cont√©m</option>
            <option value="==">igual</option>
          `;
        } else if (c === "ativo") {
          selOp.innerHTML = `<option value="==">igual</option>`;
        } else {
          selOp.innerHTML = `
            <option value="==">=</option>
            <option value=">">></option>
            <option value="<"><</option>
          `;
        }
      }

      popularOperadores();
      selCampo.addEventListener("change", popularOperadores);

      div.querySelector(".remover").onclick = () => div.remove();

      return div;
    }

    function obterFiltrosDoModal() {
      const rows = [...document.querySelectorAll("#rows .row")];

      return rows.map(r => {
        const campo = r.querySelector(".campo").value;
        const operador = r.querySelector(".operador").value;
        const valorRaw = r.querySelector(".valor").value;

        return {
          campo,
          operador,
          valor: normalizarValor(campo, valorRaw)
        };
      }).filter(f => {
        // remove filtros sem valor (evita travar)
        if (f.campo === "qtde" || f.campo === "precoVenda") {
          return Number.isFinite(f.valor);
        }
        if (f.campo === "ativo") {
          // permite vazio? n√£o. exige algo digitado
          return String(f.valor).length > 0;
        }
        return String(f.valor).trim().length > 0;
      });
    }

    // =========================
  // 6) Eventos (continua√ß√£o)
  // =========================

  document.getElementById("btnLimpar").onclick = () => {
    filtrosAtivos = [];
    operadorGlobal = "AND";

    // reseta radios
    document.querySelector('input[name="op"][value="AND"]').checked = true;

    // limpa rows
    rows.innerHTML = "";
    rows.appendChild(criarRowFiltro());

    atualizarTudo();
  };

  document.getElementById("btnAplicar").onclick = () => {
    const btn = document.getElementById("btnAplicar");
    const textoOriginal = btn.textContent;

    btn.disabled = true;
    btn.textContent = "Aplicando...";

    try {
      filtrosAtivos = obterFiltrosDoModal();

      operadorGlobal =
        document.querySelector('input[name="op"]:checked')?.value || "AND";

      atualizarTudo();
      modal.classList.remove("open");
    } finally {
      btn.textContent = textoOriginal;
      btn.disabled = false;
    }
  };

  // =========================
  // 7) Inicializa√ß√£o
  // =========================
  atualizarTudo();
</script>